"use strict";var security;!function(security){var filters;!function(filters){var CustomFilters=function(){function CustomFilters(app){this.app=app}return CustomFilters.prototype.setFilters=function(){this.app.filter("profilechan",function(){return function(input){switch(input){case 1:return"A+";case 2:return"A-";case 3:return"R+";case 4:return"R-";default:return"No chan => "+input}}})},CustomFilters}();filters.CustomFilters=CustomFilters}(filters=security.filters||(security.filters={}))}(security||(security={}));var security;!function(security){var services;!function(services){var DataService=function(){function DataService(){this._language="en",this._localStorageName="monitor";var cache=localStorage.getItem(this._localStorageName);cache&&(cache=JSON.parse(cache),this.setLogin(cache.login),this.setLanguage(cache.language))}return DataService.prototype.localStorageName=function(){return this._localStorageName},DataService.prototype.login=function(){return this._login},DataService.prototype.setLogin=function(value,isSave){this._login=value,isSave&&this.save()},DataService.prototype.language=function(){return this._language},DataService.prototype.setLanguage=function(value,isSave){this._language=value,isSave&&this.save()},DataService.prototype.save=function(){localStorage.setItem(this._localStorageName,JSON.stringify({login:this._login,language:this._language}))},DataService}();services.DataService=DataService}(services=security.services||(security.services={}))}(security||(security={}));var security;!function(security){var services;!function(services){var Inner=function(){function Inner(){}return Inner.translateAll=function(locale){var all=document.querySelectorAll("[pr-lang]");Array.prototype.forEach.call(all,function(el){var key=el.getAttribute("pr-lang");el.innerHTML=key.length>0?messageResource.get(key,locale):""})},Inner.translateValue=function(locale,key,cb){"string"==typeof key?cb(messageResource.get(key,locale)):key.forEach(function(k){cb(messageResource.get(k,locale),k)})},Inner}(),TranslateService=function(){function TranslateService(){messageResource.init({filePath:"lang/"})}return TranslateService.prototype.translateAllByLocale=function(locale){locale="Language_"+locale,TranslateService.filesLocale.indexOf(locale)<0?messageResource.load(locale,function(){Inner.translateAll(locale),TranslateService.filesLocale.indexOf(locale)<0&&(TranslateService.filesLocale+=locale+";")}):Inner.translateAll(locale)},TranslateService.prototype.translateValueByKey=function(locale,key,cb){locale="Language_"+locale,TranslateService.filesLocale.indexOf(locale)<0?messageResource.load(locale,function(){Inner.translateValue(locale,key,cb),TranslateService.filesLocale.indexOf(locale)<0&&(TranslateService.filesLocale+=locale+";")}):Inner.translateValue(locale,key,cb)},TranslateService.filesLocale="",TranslateService}();services.TranslateService=TranslateService}(services=security.services||(security.services={}))}(security||(security={}));var security;!function(security){var services;!function(services){var AuthInterceptorService=function(){function AuthInterceptorService($cookies,$log){var interceptor={};return interceptor.response=function(rejection){return 401===rejection.status&&console.log("401 in interceptor"),rejection},interceptor}return AuthInterceptorService}();services.AuthInterceptorService=AuthInterceptorService;var Auth=function(){function Auth($rootScope,$location,$http,errorService,dataService){function enter(){var path=$location.path();path!=auth.loginPath&&auth.safePath.indexOf(path)<0&&(auth.path=$location.path(),auth.authenticated||$location.path(auth.loginPath))}var lsItem=localStorage.getItem(dataService.localStorageName()),cache=lsItem?lsItem:null,auth=(cache?cache.language:"en",{loginPath:"/login",registrationPath:"/registration",logoutPath:"/logout",homePath:"/",path:$location.path(),authenticated:!1,authenticate:function(credentials,callback){var headers=credentials&&credentials.username?{authorization:"Basic "+btoa(unescape(encodeURIComponent(credentials.username+":"+credentials.password)))}:{},config={headers:headers};$http.get("resources/user",config).success(function(response,status){auth.authenticated=!!response.name,callback&&callback(auth.authenticated),auth.authenticated?$location.path(auth.path==auth.loginPath?auth.homePath:auth.path):$location.path(auth.loginPath)}).error(function(response,status){if(auth.authenticated=!1,401===status&&credentials.username){var userLockURL="resources/isUserLock/";$http.get(userLockURL+credentials.username).success(function(response){response.result&&function(){errorService.setError(response.message,response.wait)}()}).error(function(response){return console.log(response)})}callback&&callback()})},clear:function(){$location.path(auth.loginPath),auth.authenticated=!1,$http.post(auth.logoutPath,null).success(function(){return console.log("Logout succeeded")}).error(function(response,status){return console.log(401!==status?"Logout failed":"Logout succeeded")})},init:function(homePath,loginPath,logoutPath,safePath){auth.homePath=homePath,auth.loginPath=loginPath,auth.logoutPath=logoutPath,auth.safePath=safePath,auth.authenticate({},function(authenticated){authenticated&&$location.path(auth.path)}),$rootScope.$on("$routeChangeStart",function(){return enter()})}});return auth}return Auth}();services.Auth=Auth}(services=security.services||(security.services={}))}(security||(security={}));var security;!function(security){var services;!function(services){var ErrorService=function(){function ErrorService($rootScope){this.$rootScope=$rootScope}return ErrorService.prototype.setError=function(value,text){this.$rootScope.$broadcast("errorChange",{error:value,text:text})},ErrorService}();services.ErrorService=ErrorService}(services=security.services||(security.services={}))}(security||(security={}));var security;!function(security){var directives;!function(directives){function LangDirective(){return{restrict:"E",templateUrl:"html/security/directives/langDirective.html",controller:LangController,link:function(scope,elm,attrs,ctrl){scope.$on("$routeChangeStart",function(next,current){scope.changeLanguage(ctrl.dataService.language())})}}}var LangController=function(){function LangController($scope,$location,$http,translate,dataService,$timeout){this.translate=translate,this.dataService=dataService,$http.get("resources/langs",{cache:!0}).success(function(response){var locales=[],index=1;response.forEach(function(localeName){var locale={};localeName=localeName.slice(localeName.indexOf("_")+1,localeName.indexOf(".")),locale.id=localeName,locales.push(locale),$scope.lang=locales.filter(function(f){return f.id===dataService.language()})[0],translate.translateValueByKey(localeName,["kFlagLocale","kLangName"],function(value,k){-1!=value.indexOf("http")?locale.img=value:(locale.langName=value,index++==response.length&&($scope.locales=locales,translate.translateAllByLocale(dataService.language()),$timeout()))})})}),$scope.changeLanguage=function(id){translate.translateAllByLocale(id),$scope.lang=$scope.locales.filter(function(f){return f.id===id})[0],dataService.setLanguage(id,!0)}}return LangController}();directives.LangDirective=LangDirective}(directives=security.directives||(security.directives={}))}(security||(security={}));var security;!function(security){var directives;!function(directives){function Error(){return{templateUrl:"html/security/directives/errorDirective.html",controller:ErrorController,controllerAs:"errCtrl"}}var ErrorController=function(){function ErrorController($scope,$sce,errorService,translate,dataService){var _this=this;_this.close=function(){_this.langKey="",_this.message="",_this.show=!1},$scope.$on("errorChange",function(e,args){args.error?(_this.show=!0,translate.translateValueByKey(dataService.language(),args.error,function(value){_this.message=$sce.trustAsHtml(value+(args.text?" "+args.text:"")),_this.langKey=args.error,setTimeout(function(){return $scope.$apply()},100)})):_this.close()})}return ErrorController}();directives.Error=Error}(directives=security.directives||(security.directives={}))}(security||(security={}));var security;!function(security){var directives;!function(directives){function Enter(){return function(scope,element,attrs){element.bind("keydown keypress",function(event){13===event.which&&(scope.$apply(function(){scope.$eval(attrs.ngEnter)}),event.preventDefault())})}}directives.Enter=Enter}(directives=security.directives||(security.directives={}))}(security||(security={}));var security;!function(security){var directives;!function(directives){function Login(){return{restrict:"E",templateUrl:"html/security/directives/loginDirective.html",controller:LoginController,link:function(scope,elm,attrs,ctrl){scope.credentials.username=ctrl.dataService.login(),$('input[type="password"]')[0].focus(),ctrl.translate.translateAllByLocale(ctrl.dataService.language())}}}var LoginController=function(){function LoginController($scope,errorService,authService,dataService,translate){this.dataService=dataService,this.translate=translate,$scope.credentials={},$scope.progressIconClass="",$scope.login=function(){$scope.progressIconClass="fa fa-refresh fa-spin",authService.authenticate($scope.credentials,function(authenticated){authenticated?(dataService.setLogin($scope.credentials.username,!0),console.log("Login succeeded")):(console.log("Login failed"),$scope.progressIconClass="",errorService.setError("keyBadAuthentication"))})}}return LoginController}();directives.Login=Login}(directives=security.directives||(security.directives={}))}(security||(security={}));var security;!function(security){var directives;!function(directives){function UserMain(){return{restrict:"E",templateUrl:"html/security/directives/userMain.html",link:function(scope,elm,attrs,ctrl){scope.reg.translateUpdate()}}}directives.UserMain=UserMain}(directives=security.directives||(security.directives={}))}(security||(security={}));var security;!function(security){var directives;!function(directives){function UserAdditional(){return{restrict:"E",templateUrl:"html/security/directives/userAdditional.html",link:function(scope,elm,attrs,ctrl){scope.reg.translateUpdate()}}}directives.UserAdditional=UserAdditional}(directives=security.directives||(security.directives={}))}(security||(security={}));var security;!function(security){var controllers;!function(controllers){var SecurityCtrl=function(){function SecurityCtrl(authService,errorService,dataService,translate,$http,$location){this.authService=authService,this.errorService=errorService,this.$http=$http,this.$location=$location,this.DEL_USER="saferesources/delUser",this.RECOVER="resources/recover",this.recoverUser={loginEmail:""},translate.translateAllByLocale(dataService.language())}return SecurityCtrl.prototype.logout=function(){this.authService.clear()},SecurityCtrl.prototype.deleteUser=function(){var _this=this;this.$http["delete"](this.DEL_USER,{params:this.delUser}).success(function(data){"ok"===data.result?_this.authService.clear():_this.errorService.setError("Bad result.")})},SecurityCtrl}();controllers.SecurityCtrl=SecurityCtrl}(controllers=security.controllers||(security.controllers={}))}(security||(security={}));var security;!function(security){var controllers;!function(controllers){var RegistrationCtrl=function(){function RegistrationCtrl(errorService,dataService,translate,$http,$location){var _this=this;this.errorService=errorService,this.dataService=dataService,this.translate=translate,this.$http=$http,this.$location=$location,this.PROFILE="saferesources/profile",this.UPDATE_PROFILE="saferesources/updateProfile",this.ADD_USER="resources/addUser",this.USER_FIELDS="resources/getUserFields",this.createTable=!1,this.isProfile="/registration"!==$location.path(),this.isProfile?$http.get(this.PROFILE).success(function(data){delete data.password,_this.newUser=data,_this.newUser.password1="",_this.newUser.password2="",_this.setCustomFildsProfile(data)}):$http.get(this.USER_FIELDS).success(function(data){_this.newUser=data.length>0?data:new Object(null),_this.newUser.password2="",_this.createTable="object"!=typeof data,_this.createTable||_this.setCustomFildsProfile(data)}),this.translateUpdate()}return RegistrationCtrl.prototype.submit=function(){var _this=this,u=this.newUser,customFields=$("#customFields > div"),cp=[];if(customFields.each(function(id,cf){var inputs=$(cf).find("input"),select=$(cf).find("select"),name=inputs[0],value=inputs.length>1?inputs[1]:select[0],type=inputs.length>1?select[0]:select[1],val=value.value;"Timestamp"===type.value&&(val=_this.date2timestamp(value.value)),name.value.length>0&&cp.push({name:name.value,value:val,type:type.value})}),cp.length>0&&(u.customFields=cp),this.createTable||(cp.forEach(function(p){"String"===p.type?u[p.name]=p.value:"Boolean"===p.type?u[p.name]="true"===p.value.toLowerCase():u[p.name]=+p.value}),delete u.customFields),u.password1||(u.password1=""),u.password2||(u.password2=""),this.isProfile){if(u.password1!==u.password2)return void this.errorService.setError("Different passwords")}else if(u.password!==u.password2)return void this.errorService.setError("Different passwords");delete u.password2,this.isProfile?this.updateUser():(delete u.password1,this.addUser())},RegistrationCtrl.prototype.addUser=function(){var _this=this;this.$http.put(this.ADD_USER,this.newUser).success(function(data){console.log(data),"ok"===data.result?_this.$location.path("/securityTest"):_this.errorService.setError("keyBadAuthentication")})},RegistrationCtrl.prototype.updateUser=function(){var _this=this;console.log("updateUser"),console.log(this.newUser),this.$http.post(this.UPDATE_PROFILE,this.newUser).success(function(data){console.log(data),"ok"===data.result?_this.$location.path("/securityTest"):_this.errorService.setError(data.result)})},RegistrationCtrl.prototype.setCustomFildsProfile=function(user){var uClone=JSON.parse(JSON.stringify(user));this.deleteKey(uClone,"id"),this.deleteKey(uClone,"login"),this.deleteKey(uClone,"password"),this.deleteKey(uClone,"password1"),this.deleteKey(uClone,"password2"),this.deleteKey(uClone,"email"),this.deleteKey(uClone,"active"),this.deleteKey(uClone,"attempts"),this.deleteKey(uClone,"maxAttempts"),this.deleteKey(uClone,"maxattempts"),this.deleteKey(uClone,"lastmodified");for(var k in uClone){var v=uClone[k],type="String";isNaN(v)||(type="Integer",-1!=(v+"").indexOf(".")&&(type="Double",.123456789==v&&(v=0)),v>2147483647&&(type="Timestamp")),"boolean"==typeof v&&(type="Boolean"),""===v&&(type="String"),this.addUserField({name:k,value:v,type:type})}},RegistrationCtrl.prototype.deleteKey=function(obj,key){delete obj[key],delete obj[key.toUpperCase()]},RegistrationCtrl.prototype.translateUpdate=function(){this.translate.translateAllByLocale(this.dataService.language())},RegistrationCtrl.prototype.fullNumber=function(n){return 10>n?"0"+n:n},RegistrationCtrl.prototype.timestamp2date=function(dateValue,fullNumber){fullNumber=fullNumber?fullNumber:this.fullNumber;var a=dateValue,year=a.getFullYear(),month=fullNumber(a.getMonth()+1),date=fullNumber(a.getDate()),hour=fullNumber(a.getHours()),min=fullNumber(a.getMinutes()),sec=fullNumber(a.getSeconds()),S=a.getMilliseconds(),SSS=10>S?"00"+S:100>S?"0"+S:S,time=year+"-"+month+"-"+date+" "+hour+":"+min+":"+sec+"."+SSS;return time},RegistrationCtrl.prototype.date2timestamp=function(d){var y=d.slice(0,4),m=d.slice(5,7),dd=d.slice(8,10),h=d.slice(11,13),M=d.slice(14,16),s=d.slice(17,19),S=d.slice(20,23);return new Date(+y,+m,+dd,+h,+M,+s,+S)},RegistrationCtrl.prototype.addUserField=function(f){function onTypeChange(){if("Boolean"===type.value)valueField.removeChild(value),valueField.appendChild(choose);else{if(choose.parentNode==valueField&&(valueField.removeChild(choose),valueField.appendChild(value)),!isNaN(+value.value)&&"Timestamp"===type.value){var val=+value.value;val=0==val?(new Date).getTime():val,value.value=timestamp2date(new Date(val),fullNumber),value.pattern="(?:19|20)[0-9]{2}-(?:(?:0[1-9]|1[0-2])-(?:0[1-9]|1[0-9]|2[0-9])|(?:(?!02)(?:0[1-9]|1[0-2])-(?:30))|(?:(?:0[13578]|1[02])-31))\\s(0[0-9]|1[0-9]|2[0-3])(:[0-5][0-9]){2}.[0-9]{1}[0-9]{1}[0-9]{1}"}"Integer"===type.value&&(value.type="number"),"Double"===type.value&&(value.type="number",value.step="0.001")}}var fullNumber=this.fullNumber,timestamp2date=this.timestamp2date,div=$("#customFields"),field=document.createElement("div"),nameField=document.createElement("div"),valueField=document.createElement("div"),typeField=document.createElement("div"),name=document.createElement("input"),value=document.createElement("input"),choose=document.createElement("select"),chTrue=document.createElement("option"),chFalse=document.createElement("option"),type=document.createElement("select"),oString=document.createElement("option"),oBoolean=document.createElement("option"),oInteger=document.createElement("option"),oDouble=document.createElement("option"),oTimestamp=document.createElement("option");field.className="col-xs-12",field.style.padding="0",nameField.className="col-xs-4",nameField.style.padding="0",nameField.style.paddingRight="10px",valueField.className="col-xs-4",valueField.style.padding="0",valueField.style.paddingRight="10px",typeField.className="col-xs-4",typeField.style.padding="0",name.className="form-control",name.style.marginBottom="15px",name.setAttribute("placeholder","name"),value.className="form-control",value.setAttribute("placeholder","value"),choose.className="form-control",chTrue.appendChild(document.createTextNode("TRUE")),chFalse.appendChild(document.createTextNode("FALSE")),choose.appendChild(chTrue),choose.appendChild(chFalse),type.className="form-control",oString.setAttribute("value","String"),oString.appendChild(document.createTextNode("String")),type.appendChild(oString),oInteger.setAttribute("value","Integer"),oInteger.appendChild(document.createTextNode("Integer")),type.appendChild(oInteger),oDouble.setAttribute("value","Double"),oDouble.appendChild(document.createTextNode("Double")),type.appendChild(oDouble),oBoolean.setAttribute("value","Boolean"),oBoolean.appendChild(document.createTextNode("Boolean")),type.appendChild(oBoolean),oTimestamp.setAttribute("value","Timestamp"),oTimestamp.appendChild(document.createTextNode("Timestamp")),type.appendChild(oTimestamp),typeField.appendChild(type),nameField.appendChild(name),valueField.appendChild(value),field.appendChild(nameField),field.appendChild(valueField),field.appendChild(typeField),div.append(field),f&&(name.value=f.name,value.value=f.value,type.value=f.type,type.disabled=!0,name.readOnly=!0,onTypeChange(),"boolean"==typeof f.value&&(choose.value=(""+f.value).toUpperCase())),type.addEventListener("change",onTypeChange)},RegistrationCtrl}();controllers.RegistrationCtrl=RegistrationCtrl}(controllers=security.controllers||(security.controllers={}))}(security||(security={})),function(){var ctrls=security.controllers,dirs=security.directives,serv=security.services,app=angular.module("Security",["ngRoute","ngAnimate"]);app.run(function(authService,$rootScope,$route,$timeout,translate,dataService){authService.init("/","/login","/logout",["/registration","/recover"]),$rootScope.$on("$includeContentLoaded",function(event,tName){translate.translateAllByLocale(dataService.language())}),$route.reload()}),app.service("authInterceptorService",[serv.AuthInterceptorService]).service("authService",["$rootScope","$location","$http","translate","dataService",serv.Auth]).service("dataService",[serv.DataService]).service("translate",[serv.TranslateService]).service("errorService",["$rootScope",serv.ErrorService]),app.directive("langDirective",[dirs.LangDirective]).directive("loginDirective",[dirs.Login]).directive("errorDirective",[dirs.Error]).directive("ngEnter",[dirs.Enter]).directive("userMain",[dirs.UserMain]).directive("userAdditional",[dirs.UserAdditional]),app.controller("SecurityCtrl",ctrls.SecurityCtrl).controller("RegistrationCtrl",ctrls.RegistrationCtrl);var cFilters=new security.filters.CustomFilters(app);cFilters.setFilters()}();