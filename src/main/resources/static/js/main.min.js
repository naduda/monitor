"use strict";var monitor;!function(monitor){var filters;!function(filters){var CustomFilters=function(){function CustomFilters(app){this.app=app}return CustomFilters.prototype.setFilters=function(){this.app.filter("profilechan",function(){return function(input){switch(input){case 1:return"A+";case 2:return"A-";case 3:return"R+";case 4:return"R-";default:return"No chan => "+input}}})},CustomFilters}();filters.CustomFilters=CustomFilters}(filters=monitor.filters||(monitor.filters={}))}(monitor||(monitor={}));var monitor;!function(monitor){var RouteConfig=function(){function RouteConfig($routeProvider,$httpProvider){$routeProvider.when("/",{templateUrl:"main.html"}).when("/securityTest",{templateUrl:"html/security/main.html"}).when("/securityProfile",{templateUrl:"html/security/profile.html"}).when("/securityRegistration",{templateUrl:"html/security/registration.html"}).when("/login",{templateUrl:"html/login.html"}).when("/recover",{templateUrl:"html/recover.html"}).when("/registration",{templateUrl:"html/security/registration.html"}).when("/remove",{templateUrl:"html/security/remove.html"}).when("/metersData/:ids",{templateUrl:"html/templates/menu/menu_2_1/metersData.html"}).otherwise("/main"),$httpProvider.defaults.headers.common["X-Requested-With"]="XMLHttpRequest",$httpProvider.interceptors.push("authInterceptorService")}return RouteConfig}();monitor.RouteConfig=RouteConfig}(monitor||(monitor={}));var monitor;!function(monitor){var services;!function(services){var DataService=function(){function DataService(){this._language="en",this._localStorageName="monitor";var cache=localStorage.getItem(this._localStorageName);cache&&(cache=JSON.parse(cache),this.setLogin(cache.login),this.setLanguage(cache.language))}return DataService.prototype.localStorageName=function(){return this._localStorageName},DataService.prototype.login=function(){return this._login},DataService.prototype.setLogin=function(value,isSave){this._login=value,isSave&&this.save()},DataService.prototype.language=function(){return this._language},DataService.prototype.setLanguage=function(value,isSave){this._language=value,isSave&&this.save()},DataService.prototype.save=function(){localStorage.setItem(this._localStorageName,JSON.stringify({login:this._login,language:this._language}))},DataService}();services.DataService=DataService}(services=monitor.services||(monitor.services={}))}(monitor||(monitor={}));var monitor;!function(monitor){var services;!function(services){var HTTPwrapper=function(){function HTTPwrapper($http,authService){this.$http=$http,this.authService=authService}return HTTPwrapper.prototype.getHTTP=function(url,config,cbSuccess,cbError){var _this=this;this.$http.get(url,config).success(function(data,status,headers,config){cbSuccess&&cbSuccess(data,status,headers,config)}).error(function(data,status,headers,config){401===status&&(console.log("401 in HTTPwrapper getHTTP"),_this.authService.clear()),cbError&&cbError(data,status,headers,config)})},HTTPwrapper.prototype.postHTTP=function(url,data,config,cbSuccess,cbError){var _this=this;this.$http.post(url,data,config).success(function(data,status,headers,config){cbSuccess&&cbSuccess(data,status,headers,config)}).error(function(data,status,headers,config){401===status&&(console.log("401 in HTTPwrapper postHTTP"),_this.authService.clear()),cbError&&cbError(data,status,headers,config)})},HTTPwrapper}();services.HTTPwrapper=HTTPwrapper}(services=monitor.services||(monitor.services={}))}(monitor||(monitor={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},monitor;!function(monitor){var services;!function(services){var HTTPService=function(_super){function HTTPService(){_super.apply(this,arguments)}return __extends(HTTPService,_super),HTTPService.prototype.getLangs=function(success,error){this.getHTTP("resources/langs",{cache:!0},success,error)},HTTPService.prototype.getUser=function(headers,success,error){this.getHTTP("resources/user",headers,success,error)},HTTPService.prototype.resetAttempts=function(success,error){this.postHTTP("secureresources/resetBlockTimeout",null,null,success,error)},HTTPService.prototype.isUserLock=function(username,success,error){this.getHTTP("resources/isUserLock",username,success,error)},HTTPService.prototype.logout=function(url,success,error){this.postHTTP(url,null,null,success,error)},HTTPService.prototype.detectDevice=function(success,error){this.getHTTP("resources/detect-device",null,success,error)},HTTPService.prototype.registration=function(data,success,error){this.postHTTP("resources/registration",data,null,success,error)},HTTPService.prototype.deactivate=function(data,success,error){this.postHTTP("secureresources/removeProfile",data,null,success,error)},HTTPService.prototype.updateProfile=function(data,success,error){this.postHTTP("secureresources/updateProfile",data,null,success,error)},HTTPService.prototype.getProfile=function(data,success,error){this.getHTTP("secureresources/profileInfo",data,success,error)},HTTPService.prototype.recover=function(data,success,error){this.postHTTP("resources/recover",data,null,success,error)},HTTPService}(services.HTTPwrapper);services.HTTPService=HTTPService}(services=monitor.services||(monitor.services={}))}(monitor||(monitor={}));var monitor;!function(monitor){var services;!function(services){var Inner=function(){function Inner(){}return Inner.translateAll=function(locale){var all=document.querySelectorAll("[pr-lang]");Array.prototype.forEach.call(all,function(el){var key=el.getAttribute("pr-lang");el.innerHTML=key.length>0?messageResource.get(key,locale):""})},Inner.translateValue=function(locale,key,cb){"string"==typeof key?cb(messageResource.get(key,locale)):key.forEach(function(k){cb(messageResource.get(k,locale),k)})},Inner}(),TranslateService=function(){function TranslateService(){messageResource.init({filePath:"lang/"})}return TranslateService.prototype.translateAllByLocale=function(locale){locale="Language_"+locale,TranslateService.filesLocale.indexOf(locale)<0?messageResource.load(locale,function(){Inner.translateAll(locale),TranslateService.filesLocale.indexOf(locale)<0&&(TranslateService.filesLocale+=locale+";")}):Inner.translateAll(locale)},TranslateService.prototype.translateValueByKey=function(locale,key,cb){locale="Language_"+locale,TranslateService.filesLocale.indexOf(locale)<0?messageResource.load(locale,function(){Inner.translateValue(locale,key,cb),TranslateService.filesLocale.indexOf(locale)<0&&(TranslateService.filesLocale+=locale+";")}):Inner.translateValue(locale,key,cb)},TranslateService.filesLocale="",TranslateService}();services.TranslateService=TranslateService}(services=monitor.services||(monitor.services={}))}(monitor||(monitor={}));var monitor;!function(monitor){var services;!function(services){var AuthInterceptorService=function(){function AuthInterceptorService($cookies,$log){var interceptor={};return interceptor.response=function(rejection){return 401===rejection.status&&console.log("401 in interceptor"),rejection},interceptor}return AuthInterceptorService}();services.AuthInterceptorService=AuthInterceptorService;var Auth=function(){function Auth($rootScope,$location,$http,errorService,dataService){var lsItem=localStorage.getItem(dataService.localStorageName()),cache=lsItem?lsItem:null,auth=(cache?cache.language:"en",{loginPath:"/login",registrationPath:"/registration",logoutPath:"/logout",homePath:"/",path:$location.path(),authenticate:function(credentials,callback){var headers=credentials&&credentials.username?{authorization:"Basic "+btoa(unescape(encodeURIComponent(credentials.username+":"+credentials.password)))}:{},config={headers:headers},userURL="resources/user";$http.get(userURL,config).success(function(response,status){auth.authenticated=!!response.name,callback&&callback(auth.authenticated),auth.authenticated?$location.path(auth.path==auth.loginPath?auth.homePath:auth.path):$location.path(auth.loginPath)}).error(function(response,status){if(auth.authenticated=!1,401===status&&credentials.username){var userLockURL="resources/isUserLock/";$http.get(userLockURL+credentials.username).success(function(response){response.result&&function(){errorService.setError(response.message,response.wait)}()}).error(function(response){return console.log(response)})}callback&&callback()})},clear:function(){$location.path(auth.loginPath),auth.authenticated=!1,$http.post(auth.logoutPath,null).success(function(){return console.log("Logout succeeded")}).error(function(response,status){return console.log(401!==status?"Logout failed":"Logout succeeded")})},init:function(homePath,loginPath,logoutPath,registrationPath){auth.homePath=homePath,auth.loginPath=loginPath,auth.logoutPath=logoutPath,auth.registrationPath=registrationPath,auth.authenticate({},function(authenticated){authenticated&&$location.path(auth.path)}),$rootScope.$on("$routeChangeStart",function(){return enter()})}}),enter=function(){$location.path()!=auth.loginPath&&$location.path().indexOf(auth.registrationPath)<0&&$location.path().indexOf("unsafe")<0&&(auth.path=$location.path(),auth.authenticated||$location.path(auth.loginPath))};return auth}return Auth}();services.Auth=Auth}(services=monitor.services||(monitor.services={}))}(monitor||(monitor={}));var monitor;!function(monitor){var services;!function(services){var ErrorService=function(){function ErrorService($rootScope){this.$rootScope=$rootScope}return ErrorService.prototype.setError=function(value,text){this.$rootScope.$broadcast("errorChange",{error:value,text:text})},ErrorService}();services.ErrorService=ErrorService}(services=monitor.services||(monitor.services={}))}(monitor||(monitor={}));var monitor;!function(monitor){var directives;!function(directives){function LangDirective(){return{restrict:"E",templateUrl:"html/directives/langDirective.html",controller:LangController,link:function(scope,elm,attrs,ctrl){scope.$on("$routeChangeStart",function(next,current){scope.changeLanguage(ctrl.dataService.language())})}}}var LangController=function(){function LangController($scope,$location,httpService,translate,dataService,$timeout){this.translate=translate,this.dataService=dataService,httpService.getLangs(function(response){var locales=[],index=1;response.forEach(function(localeName){var locale={};localeName=localeName.slice(localeName.indexOf("_")+1,localeName.indexOf(".")),locale.id=localeName,locales.push(locale),$scope.lang=locales.filter(function(f){return f.id===dataService.language()})[0],translate.translateValueByKey(localeName,["kFlagLocale","kLangName"],function(value,k){-1!=value.indexOf("http")?locale.img=value:(locale.langName=value,index++==response.length&&($scope.locales=locales,translate.translateAllByLocale(dataService.language()),$timeout()))})})},function(data,dd){console.log(data)}),$scope.changeLanguage=function(id){translate.translateAllByLocale(id),$scope.lang=$scope.locales.filter(function(f){return f.id===id})[0],dataService.setLanguage(id,!0)}}return LangController}();directives.LangDirective=LangDirective}(directives=monitor.directives||(monitor.directives={}))}(monitor||(monitor={}));var monitor;!function(monitor){var directives;!function(directives){function Error(){return{templateUrl:"html/directives/errorDirective.html",controller:ErrorController,controllerAs:"errCtrl"}}var ErrorController=function(){function ErrorController($scope,$sce,errorService,translate,dataService){var _this=this;_this.close=function(){_this.langKey="",_this.message="",_this.show=!1},$scope.$on("errorChange",function(e,args){args.error?(_this.show=!0,translate.translateValueByKey(dataService.language(),args.error,function(value){_this.message=$sce.trustAsHtml(value+(args.text?" "+args.text:"")),_this.langKey=args.error,setTimeout(function(){return $scope.$apply()},100)})):_this.close()})}return ErrorController}();directives.Error=Error}(directives=monitor.directives||(monitor.directives={}))}(monitor||(monitor={}));var monitor;!function(monitor){var directives;!function(directives){function Enter(){return function(scope,element,attrs){element.bind("keydown keypress",function(event){13===event.which&&(scope.$apply(function(){scope.$eval(attrs.ngEnter)}),event.preventDefault())})}}directives.Enter=Enter}(directives=monitor.directives||(monitor.directives={}))}(monitor||(monitor={}));var monitor;!function(monitor){var directives;!function(directives){function Login(){return{restrict:"E",templateUrl:"html/directives/loginDirective.html",controller:LoginController,link:function(scope,elm,attrs,ctrl){scope.credentials.username=ctrl.dataService.login(),$('input[type="password"]')[0].focus(),ctrl.translate.translateAllByLocale(ctrl.dataService.language())}}}var LoginController=function(){function LoginController($scope,errorService,authService,dataService,translate){this.dataService=dataService,this.translate=translate,$scope.credentials={},$scope.progressIconClass="",$scope.login=function(){$scope.progressIconClass="fa fa-refresh fa-spin",authService.authenticate($scope.credentials,function(authenticated){authenticated?(dataService.setLogin($scope.credentials.username,!0),console.log("Login succeeded")):(console.log("Login failed"),$scope.progressIconClass="",errorService.setError("keyBadAuthentication"))})}}return LoginController}();directives.Login=Login}(directives=monitor.directives||(monitor.directives={}))}(monitor||(monitor={}));var monitor;!function(monitor){var controllers;!function(controllers){var SecurityCtrl=function(){function SecurityCtrl(authService,errorService,$http,$location){var _this=this;this.authService=authService,this.errorService=errorService,this.$http=$http,this.$location=$location,this.PROFILE="saferesources/profile",this.UPDATE_PROFILE="saferesources/updateProfile",this.ADD_USER="resources/addUser",this.DEL_USER="saferesources/delUser",this.RECOVER="resources/recover",this.newUser={login:"q",email:"q@gmail.com",password:"qwe",password2:""},this.recoverUser={login:"",email:""},$http.get(this.PROFILE).success(function(data){_this.user=data})}return SecurityCtrl.prototype.logout=function(){this.authService.clear()},SecurityCtrl.prototype.addUser=function(){var _this=this,u=this.newUser;return console.log(u.password!==u.password2),u.password!==u.password2?void this.errorService.setError("Different passwords"):void this.$http.post(this.ADD_USER,this.newUser).success(function(data){console.log(data),"ok"===data.result?_this.$location.path("/securityTest"):_this.errorService.setError("keyBadAuthentication")})},SecurityCtrl.prototype.deleteUser=function(){var _this=this;this.$http.post(this.DEL_USER,this.delUser).success(function(data){"ok"===data.result?_this.authService.clear():_this.errorService.setError("Bad result.")})},SecurityCtrl.prototype.recover=function(){var _this=this;console.log("recover");var u=this.recoverUser;0==u.email.length&&0==u.login.length?this.errorService.setError("Bad result."):this.$http.post(this.RECOVER,u).success(function(data){"ok"===data.result?_this.authService.clear():_this.errorService.setError("Bad result.")})},SecurityCtrl.prototype.check=function(){var u=this.user;return void 0==u.password1&&(u.password1=""),void 0==u.password2&&(u.password2=""),u.password1!=u.password2?(this.errorService.setError("Different passwords"),!1):!0},SecurityCtrl.prototype.updateProfile=function(){var _this=this;this.check()&&this.$http.post(this.UPDATE_PROFILE,this.user).success(function(data){console.log(data),"ok"===data.result?_this.$location.path("/securityTest"):_this.errorService.setError("keyBadAuthentication")})},SecurityCtrl}();controllers.SecurityCtrl=SecurityCtrl}(controllers=monitor.controllers||(monitor.controllers={}))}(monitor||(monitor={}));var monitor;!function(monitor){var controllers;!function(controllers){var MainCtrl=function(){function MainCtrl(dataService,$scope,$location,$http,authService){this.$http=$http,this.authService=authService,this.plugins=[],this.userName=dataService.login(),this.command="c:/gradle/bin/gradle.bat",this.parameters="-version",$http.get("secureresources/profileInfo").success(function(data){console.log(data)}),this.setPlugins()}return MainCtrl.prototype.test=function(){var _this=this;this.result=[],this.$http.post("secureresources/test",{command:this.command,params:this.parameters}).success(function(data,status,headers,config){for(var k in data)_this.result.push(data[k])})},MainCtrl.prototype.setPlugins=function(){var _this=this;this.$http.get("secureresources/plugins").success(function(data){for(var k in data)_this.plugins.push(data[k]);_this.command=_this.plugins[0]})},MainCtrl.prototype.changePlugin=function(p){this.command=p},MainCtrl.prototype.logout=function(){this.authService.clear()},MainCtrl}();controllers.MainCtrl=MainCtrl}(controllers=monitor.controllers||(monitor.controllers={}))}(monitor||(monitor={}));var monitor;!function(monitor){var controllers;!function(controllers){var RegistrationCtrl=function(){function RegistrationCtrl($location,errorService,dataService,translate,httpService){var _this=this;this.$location=$location,this.errorService=errorService,this.dataService=dataService,this.httpService=httpService,this.registration=function(){_this.errorService.setError(null);var psw="/profile"==_this.$location.path()?_this.password1:_this.password,psw2=_this.password2;if(psw=psw?psw:"",psw2=psw2?psw2:"",psw!=psw2)_this.errorService.setError("keyNewPasswordsWrong");else switch(_this.$location.path()){case"/registration":_this.registerNew();break;case"/profile":_this.update()}},this.registerNew=function(){console.log("registerNew")},this.update=function(){console.log("update"),console.log(_this);var data={email:_this.email,phone:_this.phone,langId:_this.dataService.language(),password:_this.password,password1:_this.password1,name:_this.name,middlename:_this.middlename,surname:_this.surname};_this.httpService.updateProfile(data,function(response){"success"===response.result?_this.$location.path("/main"):_this.errorService.setError(response.result)})},console.log("RegistrationCtrl");var path=$location.path();this.btnText="/profile"==path?"kApply":"kRegisterButton",this.required="/registration"==path,"/profile"==path&&httpService.getProfile(null,function(response){_this.login=response.login,_this.email=response.email,_this.name=response.name,_this.middlename=response.middlename,_this.surname=response.surname,_this.phone=response.phone,translate.translateAllByLocale(dataService.language())})}return RegistrationCtrl}();controllers.RegistrationCtrl=RegistrationCtrl}(controllers=monitor.controllers||(monitor.controllers={}))}(monitor||(monitor={})),function(){var ctrls=monitor.controllers,dirs=monitor.directives,servs=monitor.services,app=angular.module("Monitor",["ngRoute","ngAnimate"]);app.config(monitor.RouteConfig).run(function(authService,$rootScope,$route,translate,dataService){authService.init("/","/login","logout","registration"),$rootScope.$on("$includeContentLoaded",function(event,tName){translate.translateAllByLocale(dataService.language())}),$route.reload()}),app.service("authInterceptorService",[servs.AuthInterceptorService]).service("authService",["$rootScope","$location","$http","translate","dataService",servs.Auth]).service("dataService",[servs.DataService]).service("httpService",["$http","authService",servs.HTTPService]).service("translate",[servs.TranslateService]).service("errorService",["$rootScope",servs.ErrorService]),app.directive("langDirective",[dirs.LangDirective]).directive("loginDirective",[dirs.Login]).directive("errorDirective",[dirs.Error]).directive("ngEnter",[dirs.Enter]),app.controller("SecurityCtrl",ctrls.SecurityCtrl).controller("MainCtrl",ctrls.MainCtrl).controller("RegistrationCtrl",ctrls.RegistrationCtrl);var cFilters=new monitor.filters.CustomFilters(app);cFilters.setFilters()}();